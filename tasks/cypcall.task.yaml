name: CYP2D6 Calling with CypCall 
description: CYP2D6 genotype calling from an alignment file with CypCall
auto_generate_session_for_account: "{workspaceBot}"

parameters:
  - name: sample_name
    label: Sample Name
    type: string

  - name: input_file
    label: Input Alignment File
    type: file
    supports_location_mode: 'read_only'
    pattern_match:
      - "*.bam"
      - "*.cram"
    create: false

  - name: output_folder
    label: Output Folder
    type: directory
    supports_location_mode: 'no_append'

  - name: reference_file
    label: Reference File (FASTA)
    type: file
    supports_location_mode: 'read_only'
    optional: true

agent_requirements:
  cpu_cores: 4
  memory_gb: 12

steps:
  - name: cypcall
    description: Run CypCall CYP2D6 Genotyper
    type: cmd
    docker:
      image: registry.goldenhelix.com/public/cypcall:2025-12-03
    args:
      - |- # shell
        set -eu pipefail

        # Source shared utility functions
        source "${TASK_DIR}/utils/utils.sh"

        workdir="/scratch"
        cd "$workdir" || { echo "Failed to change to work directory"; exit 1; }
        cypcall_output_dir="${workdir}/output"

        case "${GH_WORKSPACE_ASSEMBLY}" in
            GRCh_37*)
                assembly="37"
                ;;
            *)
                assembly="38"
                ;;
        esac

        # Write input file to list file for CypCall
        cypcall_input_file="${workdir}/input_files.txt"
        echo "$input_file" > "$cypcall_input_file"

        # Check if input file is a CRAM file (CRAM files require reference for decompression)
        has_cram=false
        if [[ "$input_file" == *.cram ]]; then
          has_cram=true
        fi

        # Only check and copy reference if CRAM file is present
        if [ "$has_cram" = true ]; then
          if [ -z "$reference_file" ]; then
            reference_file="$WORKSPACE_DIR/${RESOURCES_PATH}/${REFERENCE_PATH}"
            if [ ! -f "$reference_file" ]; then
              echo "The default reference file does not exist at $reference_file"
              echo "Please run the task Download Genomic Reference to download the reference and then re-run this task"
              exit 1
            fi
          fi

          start_time=$SECONDS
          cp "$reference_file" . || { echo "Failed to copy reference FASTA"; exit 1; }
          cp "$reference_file".fai . || { echo "Failed to copy reference FASTA index"; exit 1; }
          local_reference_file="$(basename "$reference_file")"
          echo "Reference file copied to $local_reference_file in $((SECONDS - start_time)) seconds"
        else
          echo "No CRAM file detected in input, skipping reference file copy"
        fi

        mkdir -p $cypcall_output_dir

        # CypCall Step
        echo "================================================"
        echo "üöÄ STARTING CYP2D6 GENOTYPING WITH CYPCALL"
        echo "================================================"
        echo "üìÖ Server Time: $(date)"
        echo "üìÅ Input File: $input_file"
        echo "üì§ Output Folder: $output_folder"
        echo "‚öôÔ∏è CypCall Configuration:"
        echo "  - Assembly: $assembly"
        echo "  - Ambiguity Resolution: lowest_activity"
        echo "  - Threads: $AGENT_CPU_CORES"
        echo "  - Memory: ${AGENT_MEMORY_GB} GB"
        echo "================================================"

        # Record start time
        CYPCALL_START_TIME=$(date +%s)

        # Run CypCall analysis
        cypcall_prefix="${sample_name}_cypcall"
        export PYTHONUNBUFFERED=1
        cypcall --input "$cypcall_input_file" \
            --genome $assembly \
            $( [ "$has_cram" = true ] && echo --reference "$local_reference_file" ) \
            --prefix "$cypcall_prefix" \
            --ambiguityResolution lowest_activity \
            --outDir ${cypcall_output_dir}

        # Post-execution logging
        CYPCALL_END_TIME=$(date +%s)
        CYPCALL_DURATION=$((CYPCALL_END_TIME - CYPCALL_START_TIME))
        CYPCALL_DURATION_MIN=$((CYPCALL_DURATION / 60))
        CYPCALL_DURATION_SEC=$((CYPCALL_DURATION % 60))

        echo "================================================"
        echo "‚úÖ CYP2D6 GENOTYPING COMPLETED SUCCESSFULLY"
        echo "================================================"
        echo "‚è±Ô∏è  Execution Time: ${CYPCALL_DURATION_MIN}m ${CYPCALL_DURATION_SEC}s"

        # Copy output files
        cp "${cypcall_output_dir}/${cypcall_prefix}.json" "${output_folder}"
        cp "${cypcall_output_dir}/${cypcall_prefix}_sample_manifest.tsv" "${output_folder}"

        echo "üìÅ Output Files:"
        echo "  - ${cypcall_prefix}.json ($(format_file_size "${output_folder}/${cypcall_prefix}.json"))"
        echo "  - ${cypcall_prefix}_sample_manifest.tsv ($(format_file_size "${output_folder}/${cypcall_prefix}_sample_manifest.tsv"))"
        echo "================================================"

        output_tsv="${output_folder}/${cypcall_prefix}_sample_manifest.tsv"
        echo "cypcall_tsv=\"$output_tsv\"" > result.env
        cat result.env

  - name: update_sample_catalog
    description: Add CypCall Output to Sample Catalog
    type: cmd
    docker:
      image: ${VSPIPELINE_DOCKER_IMAGE}
    args:
      - |- # shell
        set -eu pipefail

        export GOLDENHELIX_USERDATA=${WORKSPACE_DIR}/AppData

        cd "${output_folder}"
        cypcall_tsv="/scratch/output/${sample_name}_cypcall_sample_manifest.tsv"

        # Error out if file does not exist
        if [ ! -f "$cypcall_tsv" ]; then
          echo "Error: File '$cypcall_tsv' not found!"
          exit 1
        fi

        echo "================================================"
        echo "üìä UPDATING SAMPLE CATALOG"
        echo "================================================"
        echo "üìÖ Server Time: $(date)"
        echo "üìÅ Input File: $cypcall_tsv"
        echo "================================================"

        sample_count=0
        while IFS='|' read -r sample pgx_genotypes alt_cyp2d6_genotypes alleles_tested; do
          if [[ -z "$sample" ]]; then
            continue
          fi
          
          echo "Uploading catalog data for sample: $sample"
          gautil client catalog-upsert SampleCatalog \
              Sample="$sample" \
              PGxGenotypes="$pgx_genotypes" \
              AlternativeCYP2D6Genotypes="$alt_cyp2d6_genotypes" \
              AllelesTested="$alleles_tested"
          sample_count=$((sample_count + 1))
        done < <(tail -n +2 "$cypcall_tsv" | tr '\t' '|')

        echo "================================================"
        echo "‚úÖ SAMPLE CATALOG UPDATE COMPLETED"
        echo "================================================"
        echo "üìä Updated $sample_count sample(s)"
        echo "================================================"